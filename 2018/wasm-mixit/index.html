<!DOCTYPE html>
<html>
  <head>
    <title>Faciliter le d√©veloppement d'applications web rapides avec WebAssembly</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">

      @import url(https://fonts.googleapis.com/css?family=Zilla+Slab);
      @import url(https://fonts.googleapis.com/css?family=Roboto);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono);

      .remark-slide-content {
          background-color: #0d47a1;
      }

      body {
          font-family: 'Roboto', serif;
          color: #e8eaf6;
      }

      h1, h2, h3 {
          font-family: 'Zilla Slab', sans-serif;
          font-weight: normal;
      }

      h1 {
          color: #f86728;
      }

      a {
          text-decoration: none;
          color: #f86728;
      }

      .white-bg, .white-bg h1 {
          background-color: white;
          color: black;
      }

      blockquote {
          font-style: italic;
          font-size: 1.2em;
      }
      blockquote strong {
          color: #f86728;
      }

      .remark-code, .remark-inline-code {
          font-family: 'Ubuntu Mono';
          font-size: 1.2em;
      }

      .bigger {
          font-size: 1.8em;
      }
      .bigger img {
          height: 10em;
      }
      .bigger .remark-slide-number {
          font-size: 20px;
      }

    </style>
  </head>
  <body>
    <textarea id="source" rows="100%" cols="100%">

class: center, middle

# Des applications Web rapides avec WebAssembly

### ou comment utiliser [votre langage] sur le Web !

???

Notes de celui qui parle. Si vous voyez cela, il y a un rat√© quelque part.

---

class: middle, center

# Deux gros probl√®mes du Web ?

![First world problems](./img/firstworldproblem.jpg)

---

# Les performances

<blockquote>
<p>Loading time is a major factor in page abandonment and loyalty; 53% of users
report that they abandon sites that take <strong>more than three seconds to
load</strong> (source: SOASTA Google study report).</p>

<p>Users visit more often, stay longer, search more, and buy more frequently on
sites that load quickly than on slower ones; one company found that a
conversion increase of 7% resulted from <strong>a speed improvement of as
little as .85 seconds</strong> (source: WPO Stats).</p>

<p>Slow loading is detrimental for <strong>search engine optimization
(SEO)</strong> because it can lower your site's ranking, resulting in fewer
visits, reads, and conversions; in 2018, Google will implement site speed as a
ranking signal in its mobile searches (source: Search Engine Land).</p>
</blockquote>

---

# Le langage impos√©

<blockquote class="twitter-tweet" data-conversation="none" data-lang="fr"><p lang="fr" dir="ltr">c&#39;est vraiment √ßa. On dirait le Javascript. Tout le monde en fait alors qu&#39;on sait que c&#39;est pourri.</p>&mdash; Seboss666 (@Seboss666) <a href="https://twitter.com/Seboss666/status/768819685823508481?ref_src=twsrc%5Etfw">25 ao√ªt 2016</a></blockquote>

<blockquote class="twitter-tweet" data-conversation="none" data-lang="fr"><p lang="fr" dir="ltr">ah tu veux dire que le javascript c&#39;est nul. en effet.</p>&mdash; Alice Voidstar (@CobaltVelvet) <a href="https://twitter.com/CobaltVelvet/status/832181927377514496?ref_src=twsrc%5Etfw">16 f√©vrier 2017</a></blockquote>

---

background-image: url(./img/firefox.png)
background-size: 50% auto

# [@bnjbvr](https://twitter.com/bnjbvr)

.left[such [floss](https://framasoft.org)]

.right[very [mozilla](https://mozilla.org)]

.left[so [kresus](https://kresus.org)]

.bigger.right[wow]


???

Je suis ing√©nieur logiciel, travaille pour mozilla, je raconte ma vie,
blablabla on n'est pas l√† pour √©couter ma biographie.

---

class: white-bg
background-image: url(./img/logo.png)

---

class: bigger

# C'est quoi WebAssembly ?

### Un **environnement d'ex√©cution** rapide, stable, bien d√©fini, aux performances proches du natif.
--

### Un nouveau **standard** cr√©√© en coop√©ration par Apple, Google, Microsoft et Mozilla.

--
### Un format **binaire** compact, portable, rapide √† charger et √† *compiler*.

--
### Tout √ßa int√©gr√© dans la plateforme Web.

???

Draft W3C depuis le 15 fevrier 2018

WG/CG (r√©union tous les mois / deux semaines)

Int√©gr√© = plus de plugins (cause de crashes), facile √† distribuer (pas d'app
store), √† mettre √† jour, etc.

---

class: middle, center, white-bg

# Support des navigateurs

--

![Dans tous les navigateurs](./img/browsers.png)

???

A l'heure de l'√©criture, repr√©sente 71% des navigateurs selon CanIUse.

Attention support dans Safari pour iOS, activ√© puis d√©sactiv√© puis r√©activ√©.

Existence d'un polyfill dans un sous ensemble de JS (asm.js) => am√©lioration
progressive.

---

# C'est efficace ?

--

## plus rapide √† d√©marrer
## plus rapide √† s'ex√©cuter
## plus compact

--

## debuggable

???

D√©marrage : fichier binaire, pas de parsing, pas d'ex√©cution lazy, tiered
compilation, streaming compilation, mise en cache.

Ex√©cution : langage statique typ√©, correspondance directe avec le CPU, pas
d'allocation m√©moire (GC), pr√©compilation par un gros compilateur. On est
seulement √† un petit √©cart de 20% des performances natives, et √ßa n'arr√™te pas
d'√©voluer !

Compact : binaire, moins √† t√©l√©charger, moins de repr√©sentations internes en
m√©moire, moins √† stocker en m√©moire, √©conomie en bande-passante donc co√ªts
serveurs.

Debugable : format binaire, mais repr√©sentation textuelle pour pouvoir
inspecter le code source et le deboguer ! et source maps !

---

# Cas d'utilisation

## Porter des [programmes complets](https://www.youtube.com/watch?v=TwuIRcpeUWE)

--

## Porter des [libs](https://websightjs.com/index-video.html)

--

## Utilisation dans des [libs](https://www.youtube.com/watch?v=qfnkDyHVJzs&feature=youtu.be&t=5880)

--

## Utilisation dans des [apps web](http://www.adultswim.com/etcetera/elastic-man)

???

Programmes complets : Unity / Unreal Engine.

Porter des libs : OpenCV, NaCL (crypto), compression, codecs, etc.

Utilisation dans des libs : React pour Fiber, Glimmer VM pour Ember, etc.

Utilisation dans des apps web : c'est ce qui nous int√©resse ici !

---

class: middle

# Pourquoi dans votre app Web ?

--

### R√©soudre une probl√©matique sp√©cifique de performances

--

### ... Changer de langage ?

???

Premature optimization root of all evil.

- Trouver les 20% de code qui prennent 80% du temps, avec un profiler.
- Optimiser ces 20%.
- S'il y a un autre probl√®me de performance, reprendre un profiler.

---

class: bigger

# Ces langages qui compilent vers wasm

- C/C++ ([Emscripten](http://emscripten.org/), LLVM)
- .NET ([Blazor](https://github.com/aspnet/blazor))
- JVM ([TeaVM](https://github.com/konsoletyper/teavm))
- Go
- Elixir
- Kotlin
- Faust

--
- [... et tous les autres](https://github.com/appcypher/awesome-wasm-langs)

--
- Rust !

---

class: middle, center

# Rust

![Rust loves JS](./img/rust_love_js.png)

(Copyright [Lin Clark](https://hacks.mozilla.org/2018/03/making-webassembly-better-for-rust-for-all-languages))

???

- Langage bas-niveau / "syst√®me"
- Mais avec une expressivit√© haut niveau
- Tr√®s rapide (langage compil√©, typ√© statiquement)
- Vous emp√™che de faire des erreurs au moment de la compilation
- Multithread√© et safe

Initiative de Mozilla, mais utilisation d√©passe Moz.
Dropbox, CoreOS, Coursera, OVH, npm inc, ... et GlimmerVM dans Ember !

---

# C++ üî´ üë£

```c++
struct Obj {
    int x;
    Obj(int x) : x(x) {}
};
void func(Obj** obj) {
    Obj tmp(42);
    *obj = &tmp;
}
void main() {
    Obj* obj;
    func(&obj);
    std::cout << obj->x << std::endl;
}
```

---

# Rust üòÖ

```rust
fn main() {
    let x: &i32;
    {
        let y = 100;
        x = &y;
    }
    println!("Hello, {}", *x);
}
```

---

# Sauv√© par le compilateur !

```
error[E0597]: `y` does not live long enough
 --> src/main.rs:5:14
  |
5 |         x = &y;
  |              ^ borrowed value does not live long enough
6 |     }
  |     - `y` dropped here while still borrowed
7 |     println!("Hello, {}", *x);
8 | }
  | - borrowed value needs to live until here

error: aborting due to previous error

For more information about this error, try
`rustc --explain E0597`.
```

---

# Installer Rust

### A ne faire qu'une seule fois ‚ö†Ô∏è


```
curl https://sh.rustup.rs -sSf | sh
export PATH=$HOME/.cargo/bin:$PATH
rustup toolchain install nightly
rustup target add wasm32-unknown-unknown --toolchain nightly
```

???

Attention en t√©l√©chargeant et streamant dans sh.

---

# Commencer un projet

Initialiser le projet :

```
cargo +nightly new --lib example
```

Ajouter dans le fichier `Cargo.toml` :

```
[lib]
crate-type = ["cdylib"]
```

Build vers WebAssembly :

```
cd example
cargo +nightly build --target wasm32-unknown-unknown \
    --release
```

---

### [Rust](./example/index.html)

```rust
#[no_mangle]
pub extern fn add_one(a: u32) -> u32 {
    a + 1
}
```

--

### JavaScript

```js
// ‚ö†Ô∏è mimetype application/wasm
const response = fetch('example.wasm');
(async function() {
    let { instance } =
        await WebAssembly.instantiateStreaming(response);
    let result = instance.exports.add_one(41);
    alert(`The answer is ${result}`);
})();
```

---

# Probl√®mes de cette approche

### Etape de *build* pas int√©gr√©e
### N√©cessit√© de toucher aux APIs WebAssembly
### Interactions plus complexes ?
### Interop√©rabilit√© avec des types plus complexes ?

???

Wasm fournit beaucoup d'abstractions bas niveau (table de fonctions, fonctions,
bloc de m√©moire lin√©aire), mais ne permet pas d'utiliser des types plus haut
niveau : cha√Æne de caract√®res, bool√©ens, ou types d√©finis par les devs.

Possibilit√© d'appeler des fonctions JS depuis Wasm et inversement.

---

class: bigger

# [Passer une cha√Æne de caract√®res](./example/complex.html)

### De JS √† Rust

- transformer cette cha√Æne dans sa repr√©sentation en octets
- mettre cette repr√©sentation en m√©moire wasm
- c√¥t√© Rust, construire une cha√Æne depuis cette repr√©sentation

--

### De Rust √† JS

- la m√™me... en sens inverse !

---

class: center, middle

# Et si des outils faisaient le travail pour nous ?

---

# Build / bundle

Webpack >= 4.0.0 / Parcel >= v1.5.0

```
npm install -g webpack@4.0.1
```

Et ensuite :

```
import * as wasm from './module.wasm';
```

---

# wasm-bindgen

Pour l'interop√©rabilit√© entre les deux mondes.

```
cargo install wasm-bindgen-cli
```

Ajouter au `Cargo.toml` :

```
[dependencies]
wasm-bindgen = "0.2"
```

Des annotations dans le code...

Apr√®s le build Rust :

```
wasm-bindgen \
  target/wasm32-unknown-unknown/release/project_name.wasm \
  --out-dir .
```

???

wasm-bindgen g√©n√®re du code Rust et du code JS pour interagir plus facilement
entre les deux mondes.

- le code wasm r√©sultant contient un tout petit allocateur de m√©moire pour
pouvoir passer des param√®tres (via la m√©moire wasm).
- et des wrappers Rust pour reconstruire les arguments pass√©s depuis la m√©moire
ou les valeurs retourn√©es vers la m√©moire par les fonctions.
- le code JS contient des wrappers pour simplifier le passage de valeurs dans
l'autre sens √©galement.

Au final :
- 1 fichier JS qui propose une interface similaire √† celle du code Rust
- 1 fichier wasm qui sera import√© par le module JS

Outil g√©n√©rique, destin√© √† fonctionner avec tous les langages sources.

Mais comment les outils (compilateur et wasm-bindgen) savent quel code
augmenter ?

---

# Annotations wasm-bindgen

```rust
#![feature(proc_macro, wasm_custom_section, \
    wasm_import_module)]

extern crate wasm_bindgen;

use wasm_bindgen::prelude::*;

#[wasm_bindgen]
extern {
    // Declare a JavaScript function.
    fn alert(msg: &str);
}
```

---

# D√©clarer une fonction

```rust
#[wasm_bindgen]
pub extern fn hello_world(name: &str) {
    let formatted = format!("Hello, {}", name);
    alert(&formatted);
}
```

```js
import('./project.js').then(project => {
    project.hello_world("Benjamin");
});
```

---

# D√©clarer un type

```rust
#[wasm_bindgen]
pub struct HelloFactory {
    name: String
}
#[wasm_bindgen]
impl HelloFactory {
    pub fn new(name: String) -> HelloFactory {
        HelloFactory { name: name }
    }
    pub fn say_hello(&self) {
        alert(&format!("Hello, {}", self.name));
    }
}
```

```js
import('./project.js').then(project => {
    let factory = project.HelloFactory.new("Benjamin");
    factory.say_hello();
    factory.free();
});
```

---

class: middle, center, bigger

# D√©mo compl√®te : un correcteur de typos

Benjamin, j'esp√®re que t'as pas oubli√© de lancer `webpack-dev-server`, sinon
[ce lien](http://localhost:8080) ne va pas marcher.

???

Quid des autres langages ?

---

# Et le futur ?

--

### host bindings

--

### garbage collector

--

### shared array buffers

--

Et tout le reste : SIMD, exception handling,...

---

class: center, middle

# En r√©sum√©

### plus rapide √† charger
### plus rapide √† l'ex√©cution

--

### *B.Y.O.L* (Bring Your Own Langage)

---

class: middle, center

# Merci !

### slides : [bnjbvr.github.io/slides/2018/wasm-mixit](https://bnjbvr.github.io/slides/2018/wasm-mixit)
### canal IRC : [#wasm](https://kiwiirc.com/client/irc.mozilla.org/#wasm) sur irc.mozilla.org
### Rust+Wasm : [github.com/rustwasm](https://github.com/rustwasm/)
### WebAssembly : [webassembly.org](https://webassembly.org/)
### Infos : [@WasmWeekly](https://twitter.com/WasmWeekly)
### [@bnjbvr](https://twitter.com/bnjbvr)

    </textarea>
    <script src="remark.js">
    </script>
    <script>
var slideshow = remark.create({
    highlightLanguage: "javascript",
    highlightLines: true,
    countIncrementalSlides: false
});
    </script>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </body>
</html>
