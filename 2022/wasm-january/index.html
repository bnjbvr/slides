<!DOCTYPE html>
<html>
  <head>
    <title>WebAssembly, histoire et fonctionnement</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">

      @import url(https://fonts.googleapis.com/css?family=Zilla+Slab);
      @import url(https://fonts.googleapis.com/css?family=Roboto);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono);

      .remark-slide-content {
          background-color: #e5f2f5;
      }

      body {
          font-family: 'Roboto', serif;
          color: #189ab4;
      }

      h1, h2, h3 {
          font-family: 'Zilla Slab', sans-serif;
          font-weight: normal;
      }

      h1 {
          color: #05445e;
      }

      a {
          text-decoration: none;
          color: #05445e;
      }

      .white-bg, .white-bg h1 {
          background-color: white;
          color: black;
      }

      .black-bg, .black-bg h1 {
          background-color: black;
          color: white;
      }

      .black-bg a {
          color: #3abce6;
      }

      blockquote {
          font-style: italic;
          font-size: 1.2em;
      }
      blockquote strong {
          color: #189ab4;
      }

      .remark-code, .remark-inline-code {
          font-family: 'Ubuntu Mono';
          font-size: 1.2em;
      }

      .bigger {
          font-size: 1.8em;
      }
      .bigger img {
          height: 10em;
      }
      .bigger .remark-slide-number {
          font-size: 20px;
      }

    </style>
  </head>
  <body>
    <textarea id="source" rows="100%" cols="100%">

class: center, middle

# WebAssembly, histoire et fonctionnement

???

Notes de celui qui parle. Si vous voyez cela, il y a un rat√© quelque part.

---

class: black-bg
background-image: url(./img/embark.png)
background-size: 50% auto

# [@bnjbvr](https://twitter.com/bnjbvr)

.left[such [floss](https://framasoft.org)]

.right[very [code](https://github.com/bnjbvr)]

.left[so [kresus](https://kresus.org)]

.bigger.right[wow]

???

Je suis ing√©nieur logiciel, travaille pour mozilla, je raconte ma vie,
blablabla on n'est pas l√† pour √©couter ma biographie.

---

class: black-bg
background-image: url(./img/mozilla.png)
background-size: 50%

# Tout a commenc√© avec un stage ü§ì

???

- aux alentours de 2013

---

class: center, middle

# üíñ JavaScript

![](./img/js.png)

???

- tout commence avec JavaScript, le langage de "la logique" dans le Web
- postulat de base :
    - rendre JavaScript plus rapide permet de faire de nouvelles choses sur le Web
    - et hors du web avec nodejs
    - Mozilla aime le web
        - plateforme ouverte
        - utilisateur a le controle
        - distribution facile
        - pervasif
    - concurrence avec autres moteurs
    - ergo, on investit dans les performances de JavaScript

---

# üö§ De l'importance des perfs

<blockquote>
<p>Loading time is a major factor in page abandonment and loyalty; 53% of users
report that they abandon sites that take <strong>more than three seconds to
load</strong> (source: SOASTA Google study report).</p>

<p>Users visit more often, stay longer, search more, and buy more frequently on
sites that load quickly than on slower ones; one company found that a
conversion increase of 7% resulted from <strong>a speed improvement of as
little as .85 seconds</strong> (source: WPO Stats).</p>

<p>Slow loading is detrimental for <strong>search engine optimization
(SEO)</strong> because it can lower your site's ranking, resulting in fewer
visits, reads, and conversions; in 2018, Google will implement site speed as a
ranking signal in its mobile searches (source: Search Engine Land).</p>
</blockquote>

---

# üöÑ Comment acc√©l√©rer JS ?

```javascript
function f(a, b) {
    return a + b;
}

let sum = 0;
for (let i = 0; i < 10000; ++i) {
    sum += f(i, i + 1);
}
console.log('sum =', sum);
```

???

- langage interpr√©t√©
- typage dynamique

---

class: center, middle

# üöÑ Comment acc√©l√©rer JS ?

![](./img/jit-diagram.png)

???

- Explications rapides sur les JITs

---

# ü§° Un langage dynamique

```javascript
function f(a, b) {
    return a + b;
}

f(1, 2); // 3
f(0.5, -Infinity); // -Infinity
f("bon", "jour"); // bonjour
f({
    valueOf() {
        alert('lol');
        return 42;
    }
}, 13); // renvoie 55
```

---

class: white-bg

# üêâ Emscripten et LLVM

![](img/emscripten.png)
![](img/llvm.png)

???

Emscripten = outil qui permet de compiler des gros programmes existants vers
JS.

Aubaine √©norme ! possible de d√©velopper "une seule fois" en C ou C++, et
r√©utiliser tel quel vers le Web.

Des programmes ambitieux sont compil√©s vers le web, de plus en plus gros et de
plus en plus gourmands : codecs, sqlite (base de donn√©es), jeux vid√©os,...

Quelques probl√®mes sur le fait d'utiliser JavaScript :

- temps de chargement du code pouvant √™tre tr√®s longs
- le code est interpr√©t√© au d√©but, et s'ex√©cute donc lentement pendant la
p√©riode de chauffe
- la recompilation du code peut prendre du temps et causer des ralentissements
- si une hypoth√®se implant√©e dans le code g√©n√©r√© est invalid√©e, alors
l'ex√©cution retourne dans l'interpr√©teur
- le code est parfois interrompu par le GC

---

class: white-bg
background-image: url(./img/asmjs.png)
background-size: 50%

???

- sp√©cification con√ßue par Mozilla
- Sous-ensemble strict de JavaScript => s'ex√©cute absolument de partout de
base
    - pas une nouvelle extension que les autres navigateurs doivent supporter
    - une convention, √† partir du moment o√π le code contient l'annotation "use
    asm"
    - utilise des annotations qui enl√®vent tout doute possible quant aux types
    des variables
- choix de conception d'asm.js :
    - pas de GC
    - g√©n√©r√© par Emscripten ou des compilateurs qui font d√©j√† le plus gros
    travail d'optimisation de leur c√¥t√©
    - compil√© d√©s qu'il est charg√© dans le navigateur vers du code machine
- propri√©t√©s :
    - tr√®s rapide √† l'ex√©cution
    - pas de "sursauts"
- beaucoup d'id√©es qui seront reprises dans webassembly:
    - peu de primitives de base
    - bloc de m√©moire lin√©aire exclusivement d√©di√© au module de code,
    adressable, chaque acc√®s m√©moire est v√©rifi√©
    - possibilit√© d'importer du code depuis l'ext√©rieur, pour interagir avec
    l'environnement
    - tables de fonctions pour impl√©menter le polymorphisme d'objets en C++
    - variables globales isol√©es dans le module

---

# Exemple d'asm.js

```javascript
function m(stdlib)
{
  "use asm";
  var abs = stdlib.Math.abs;
  function f(d)
  {
    d = +d;
    return (~~(5.0 - +abs(d)))|0;
  }
  return f;
}

// Instancier le module (seulement une fonction ici)
var f = m(this);
// Ex√©cuter la fonction
if (f(0.2) !== 4) { console.error("invalid result!"); }
```

???

- commenter le code
- alien, mais pas √©crit par des humains

---

class: white-bg
background-image: url(./img/pnacl.png)
background-size: 70%

# Pendant ce temps-l√†...

???

- Google a envie d'un support du code natif pour le web
- cr√©√© la spec NaCl (Native Client), de mani√®re pas ouverte, l'impl√©mente et
rajoute le support dans Chrome en m√™me temps
- mais pas portable ; it√©ration suivante "portable" pNaCl
    - quelques points communs avec wasm : une √©tape de compilation super rapide
    dans le navigateur, du format portable pexe vers le code machine natif
    - utilise LLVM pour la compilation
- en dehors de la plateforme Web (dispo uniquement sur Chrome Web Store) = un Flash 2.0
- Microsoft voit l'int√©r√™t d'asm.js et d√©cide de l'optimiser particuli√®rement
dans Chakra, leur moteur JS de l'√©poque
- il y a donc un vrai besoin, une vraie envie d'ex√©cuter du code natif dans le
Web, comment on fait ?

---

class: white-bg
background-image: url(./img/logo.png)

---

class: bigger

# C'est quoi WebAssembly ?

### Un **environnement d'ex√©cution** rapide, stable, bien d√©fini, aux performances proches du natif.
--

### Un nouveau **standard** cr√©√© en coop√©ration par Apple, Google, Microsoft et Mozilla.

--
### Un format **binaire** compact, portable, rapide √† charger et √† *compiler*.

--

### Tout √ßa int√©gr√© dans la plateforme Web (et pas que).

---

# Propri√©t√©s

--

## format compact

## d√©marre rapidement

## s'ex√©cute tr√®s rapidement

## s√©curis√©

## extensible

???

Compact : binaire, moins √† t√©l√©charger, moins de repr√©sentations internes en
m√©moire, moins √† stocker en m√©moire, √©conomie en bande-passante donc co√ªts
serveurs.

D√©marrage : fichier binaire compact, format d√©fini pour pouvoir √™tre compil√© en
une seule passe, streaming compilation, mise en cache du code g√©n√©r√©.

Ex√©cution : langage statique typ√©, correspondance directe avec le CPU, pas de
gestion automatique de la m√©moire (GC), pr√©compilation par un gros compilateur
en amont (LLVM).
Environ √©cart de 20% avec les perfs natives, selon les cas d'utilisation.

S√©curis√© : environnement bac √† sable, m√©moire isol√©e, pas de sauts ou d'appels
de fonction arbitraires (i.e. pas de goto), conception qui pr√©f√®re les erreurs
aux exploits (better safe than sorry! e.g. acc√®s m√©moires contr√¥l√©s)

Extensible : possible d'interagir avec l'environnement via imports, extensions
de la spec, sections binaires d√©finissables par les d√©veloppeurs

---

class: white-bg
background-image: url(./img/compilation.png)
background-size: 90%

# Double compilation

---

# Petit exemple

```lisp
(module
  (type $t0 (func (result i32)))
  (type $t2 (func (param i32) (result i32)))
  (import "env" "value" (func $value (type $t0)))
  (func $add
        (export "add")
        (type $t2) (param $p0 i32) (result i32)
    (i32.add
        (call $value)
        (get_local $p0)
    )
  )
)
```

???

- Commenter les diff√©rentes sections

---

# API JavaScript

```javascript
let bytes = [...];
let module = WebAssembly.compile(bytes);
let instance = WebAssembly.instantiate(module, {
    env: {
        value() {
            return 42;
        }
    }
});
instance.exports.add(13);
```

---

# (Quelques) sections binaires

- `Type section` : toutes les signatures des fonctions qui vont √™tre utilis√©es.
- `Import section` : liste des entit√©s import√©es dont le module a besoin pour
√™tre instanci√©.
- `Function section` : liste des fonctions d√©finies directement par le module.
- `Export section` : tous les entit√©s qui sont r√© export√©es par le module
- `Code section`: le corps des fonctions elles-m√™mes, avec des opcodes par
op√©ration.

---


# Merci !

### Site officiel : [webassembly.org](https://webassembly.org/)
### [A cartoon intro to WebAssembly](https://hacks.mozilla.org/2017/02/a-cartoon-intro-to-webassembly)
### News: [@WasmWeekly](https://twitter.com/WasmWeekly)
### [@bnjbvr](https://twitter.com/bnjbvr)

    </textarea>
    <script src="remark.js">
    </script>
    <script>
var slideshow = remark.create({
    highlightLanguage: "javascript",
    highlightLines: true,
    countIncrementalSlides: false
});
    </script>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </body>
</html>
